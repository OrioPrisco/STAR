<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Recommended meta tags -->
		<meta charset="UTF-8">
		<title>Yep, That's a website</title>
		<!-- This script tag bootstraps PyScript -->
		<script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
		<!-- my css -->
		<style>
			#work-area {
				--highlight-color: gold;
				flex-grow : 1;
				white-space: pre;
			}
			body {
				display:flex;
				flex-flow:column;
			}
			h1 { text-align : center; }
			.hidden { display:none }
			@keyframes highlight {
				0% {}
				10% {border-color: var(--highlight-color);}
				20% {border-color: var(--highlight-color);}
				100% {}
			}
			.highlight {
				animation : highlight 3s;
			}
			.error {
				--highlight-color: orange;
				border: 1px solid red;
				background: rgb(255, 221, 221);
				font-family: courier, monospace;
				overflow-x: auto;
				padding: 8px;
				margin-top: 8px;
				white-space: pre;
			}
			.warning {
				--highlight-color: red;
				border: 1px solid orange;
				background: #fff27d;
				font-family: courier, monospace;
				overflow-x: auto;
				padding: 8px;
				margin-top: 8px;
				white-space: pre;
			}
		</style>
		<!-- based on https://gist.github.com/incubated-geek-cc/145ef838d5d5133e9414a0086603849f -->
		<style>
			#work-area, #lineCounter {
				box-sizing: border-box;
				resize: none;
				outline: none;
			}
			#lineCounter {
				overflow-y: hidden;
				text-align: right;
				width: 3.5rem;
			}
			#editorWrapper {
				display: flex;
				flex-flow: row;
				flex: 1 1 auto;
			}
		</style>
		<!-- Splash screen-->
		<script type="module">
			const loading = document.getElementById('loading');
			addEventListener('py:all-done', () => loading.close());
			loading.showModal();
		</script>
		<style>
			#loading { outline: none; border: none; background: transparent }
		</style>
		<!-- my code -->
		<script>
			regular_logger = {interactive:false, warn:add_warning, error:add_error, debug: console.log}
			function clear_notifications() {
				document.getElementById("errors").replaceChildren();
				document.getElementById("warnings").replaceChildren();
			}
			function escape_chars(text) {
				return text.replace("&", "&amp").replace(">", "&gt").replace("<", "&lt")
			}
			function add_error(title, content) {
				details = document.createElement("details")
				summary = document.createElement("summary")
				p = document.createElement("p")
				summary.innerHTML = escape_chars(title)
				p.innerHTML = escape_chars(content)
				details.replaceChildren(summary, p)
				details.classList.add("error")
				document.getElementById("errors").append(details)
				highlight_elem(details)
			}
			function add_warning(title, content) {
				details = document.createElement("details")
				summary = document.createElement("summary")
				p = document.createElement("p")
				summary.innerHTML = escape_chars(title)
				p.innerHTML = escape_chars(content)
				details.replaceChildren(summary, p)
				details.classList.add("warning")
				document.getElementById("warnings").append(details)
				highlight_elem(details)
			}
			function highlight_elem(elem) {
				elem.classList.remove('highlight');
				void elem.offsetWidth;
				elem.classList.add('highlight');
			}
			function check_json() {
				clear_notifications();
				text = document.getElementById("work-area").value;
				if (!text)
					return ;
				try {
					clear_notifications();
					encode_json(text, regular_logger);
				} catch (error) {
					return ;
				}
			}
			addEventListener('py:all-done', check_json);
			function on_upload() {
				clear_notifications();
				document.getElementById("work-area").value = "loading...";
				var reader = new FileReader();
				reader.readAsText(this.files[0], "UTF-8");
				reader.onload = (evt) => {
					textarea = document.getElementById("work-area")
					text = evt.target.result
					const filename = this.files[0].name;
					if (filename.endsWith(".json")) {
						textarea.value = text
						check_json();
					}
					else if (filename.endsWith(".d13")) {
						try {
							decoded = decode_gamesave(text, regular_logger)
						} catch (error) {
							document.getElementById("errors").scrollIntoView({ behavior: "smooth"});
							return;
						}
						textarea.value = decoded
					} else {
						add_error("Cannot load file " + filename, "Unrecognized file extension");
						document.getElementById("errors").scrollIntoView({ behavior: "smooth"});
						line_counter();
						textarea.scrollTop = 0;
						return ;
					}
					highlight_elem(textarea)
					textarea.scrollTop = 0;
					line_counter();
				};
				reader.onerror = (evt) => {
					textarea = document.getElementById("work-area")
					highlight_elem(textarea)
					document.getElementById("work-area").value = "Error check console for further info";
				};
			}
			window.onload = () => {
				document.getElementById("upload").addEventListener("change", on_upload);
				document.getElementById("work-area").addEventListener("input", check_json);
			}
			function on_download(extension) {
				const anchor = document.getElementById("hack-anchor");
				text = document.getElementById("work-area").value
				anchor.download = "gamesave." + extension;
				if (extension == "d13") {
					clear_notifications();
					try {
						text = encode_json(text, regular_logger)
					} catch (error) {
						document.getElementById("errors").scrollIntoView({ behavior: "smooth"});
						return;
					}
				}
				var blob = new Blob([text]);
				anchor.href = URL.createObjectURL(blob);
				anchor.click();
			}
		</script>
	</head>
	<body>
		<noscript>You need to enable JavaScript to run this app.</noscript>
		<dialog id="loading">
			<h1>Loading...</h1>
		</dialog>
		<h1>STAR: savefile tool for Star of Providence</h1>
		<div style="width:90%; margin: auto; display:flex; flex-flow:column; flex: 1 1 75vh;" class="pyscript">
			<p id="editorWrapper">
				<textarea autocorrect="off" autocapitalize="off" spellcheck="false" id="lineCounter" readonly></textarea>
				<textarea autocorrect="off" autocapitalize="off" spellcheck="false" id="work-area" ></textarea>
			</p>
			<div>
				<input class="hidden" type="file" id="upload" accept=".json, .d13">
				<button onclick="document.getElementById('upload').click()">Upload</button>
				<button onclick="
					{navigator.clipboard.writeText(document.querySelector('#work-area').value).then(
						function () {alert('Copied to clipboard !')}
					)}">
					Copy to clipboard
				</button>
				<button id="download_d13" onclick="on_download('d13')">Download as .d13</button>
				<button id="download_json" onclick="on_download('json')">Download as json</button>
				<a href="" download="gamesave" class="hidden" id="hack-anchor"></a>
			</div>
			<script type="py" src="./main.py" config="./pyscript.toml"></script>
		</div>
		<div id="warnings"></div>
		<div id="errors"></div>
		<!-- based on https://gist.github.com/incubated-geek-cc/145ef838d5d5133e9414a0086603849f -->
		<script>
			var codeEditor = document.getElementById('work-area');
			var lineCounter = document.getElementById('lineCounter');

			var lineCountCache = 0;
			function line_counter() {
				var lineCount = codeEditor.value.split('\n').length;
				var outarr = new Array();
				if (lineCountCache != lineCount) {
					for (var x = 0; x < lineCount; x++) {
						outarr[x] = (x + 1) + '.';
					}
					lineCounter.value = outarr.join('\n');
				}
				lineCountCache = lineCount;
			}

			codeEditor.addEventListener('scroll', () => {
				lineCounter.scrollTop = codeEditor.scrollTop;
				lineCounter.scrollLeft = codeEditor.scrollLeft;
			});

			codeEditor.addEventListener('input', () => {
				line_counter();
			});

			codeEditor.addEventListener('keydown', (e) => {
				let { keyCode } = e;
				let { value, selectionStart, selectionEnd } = codeEditor;
				if (keyCode === 9) {  // TAB = 9
					e.preventDefault();
					codeEditor.value = value.slice(0, selectionStart) + '\t' + value.slice(selectionEnd);
					codeEditor.setSelectionRange(selectionStart+2, selectionStart+1)
				}
			});

			line_counter();
		</script>
	</body>
</html>

