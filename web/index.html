<!DOCTYPE html>
<html>
	<head>
		<!-- Recommended meta tags -->
		<meta charset="UTF-8">
		<!-- This script tag bootstraps PyScript -->
		<script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
		<style>
			textarea {
				--default-color: black;
				--highlight-color: gold;
				border-color : var(--default-color);
			}
			#loading { outline: none; border: none; background: transparent }
			html, body, .full_height { height : 100%; }
			textarea { width : 100%; flex-grow : 1; }
			h1 { text-align : center; }
			.hidden { display:none }
			@keyframes highlight {
				0% {border-color: var(--default-color);}
				10% {border-color: var(--highlight-color);}
				20% {border-color: var(--highlight-color);}
				100% {border-color: var(--default-color);}
			}
			.highlight {
				animation : highlight 3s;
			}
			.error {
				--default-color: red;
				--highlight-color: orange;
				border: 1px solid red;
				background: rgb(255, 221, 221);
				color: black;
				font-family: courier, monospace;
				white-space: pre;
				overflow-x: auto;
				padding: 8px;
				margin-top: 8px;
			}
		</style>
		<!-- for splashscreen -->
		<script type="module">
			const loading = document.getElementById('loading');
			addEventListener('py:ready', () => loading.close());
			loading.showModal();
		</script>
		<script>
			function clear_errors() {
				for (const node of document.querySelectorAll(".error"))
					node.remove()
			}
			function add_error(content) {
				content = content.replace("&", "&amp")
				.replace(">", "&gt")
				.replace("<", "&lt")
				div = document.createElement("pre")
				div.innerHTML = content;
				div.classList.add("error")
				document.body.append(div)
				highlight_elem(div)
			}
			function highlight_elem(elem) {
				elem.classList.remove('highlight');
				void elem.offsetWidth;
				elem.classList.add('highlight');
				elem.scrollIntoView({ behavior: "smooth"});
			}
			function on_upload() {
				clear_errors();
				document.getElementById("work-area").value = "loading...";
				var reader = new FileReader();
				reader.readAsText(this.files[0], "UTF-8");
				reader.onload = (evt) => {
					textarea = document.getElementById("work-area")
					text = evt.target.result
					if (this.files[0].name.endsWith(".json")) {
						textarea.value = text
						//TODO use something better than alert
						try {
							encode_json(text, console.error)
						} catch (error) {
							alert("Warning : Invalid json, check the console for more details")
						}
					}
					else if (this.files[0].name.endsWith(".d13")) {
						decoded = decode_gamesave(text, add_error)
						textarea.value = decoded
					}
					highlight_elem(textarea)
				};
				reader.onerror = (evt) => {
					textarea = document.getElementById("work-area")
					highlight_elem(textarea)
					document.getElementById("work-area").value = "Error check console for further info";
				};
			}
			window.onload = () => {
				document.getElementById("upload").addEventListener("change", on_upload);
			}
			function on_download(extension) {
				clear_errors();
				const anchor = document.getElementById("hack-anchor");
				text = document.getElementById("work-area").value
				anchor.download = "gamsave." + extension;
				if (extension == "json") {
					//TODO use something better than alert
					try {
						encode_json(text, console.error)
					} catch (error) {
						alert("Warning : Invalid json, check the console for more details")
					}
				}
				else if (extension == "d13") {
					text = encode_json(text, add_error)
				}
				var blob = new Blob([text]);
				anchor.href = URL.createObjectURL(blob);
				anchor.click();
			}
		</script>
	</head>
	<body>
		<dialog id="loading">
			<h1>Loading...</h1>
		</dialog>
		<h1>STAR: savefile tool for Star of Providence</h1>
		<div style="height:85%; width:90%; margin: auto;">
			<section class="pyscript full_height" style="display:flex; flex-flow:column; width:100%;">
				<textarea id="work-area" ></textarea>
				<div>
					<input class="hidden" type="file" id="upload" accept=".json, .d13"></input>
					<button onclick="document.getElementById('upload').click()">Upload</button>
					<button onclick="
						{navigator.clipboard.writeText(document.querySelector('#output').value).then(
							function () {alert('Copied to clipboard !')}
						)}">
						Copy to clipboard
					</button>
					<button id="download_d13" onclick="on_download('d13')">Download as .d13</button>
					<button id="download_json" onclick="on_download('json')">Download as json</button>
					<a download="gamesave" class="hidden" id="hack-anchor"></a>
				</div>
				<script type="py" src="./main.py" config="./pyscript.toml"></script>
				<div>
				</div>
			</section>
		</div>
	</body>
</html>

