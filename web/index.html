<!DOCTYPE html>
<html>
	<head>
		<!-- Recommended meta tags -->
		<meta charset="UTF-8">
		<!-- This script tag bootstraps PyScript -->
		<script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
		<style>
			#work-area {
				--default-color: black;
				--highlight-color: gold;
				border-color : var(--default-color);
				width : 100%;
				flex-grow : 1;
			}
			#loading { outline: none; border: none; background: transparent }
			html, body, .full_height { height : 100%; }
			h1 { text-align : center; }
			.hidden { display:none }
			@keyframes highlight {
				0% {border-color: var(--default-color);}
				10% {border-color: var(--highlight-color);}
				20% {border-color: var(--highlight-color);}
				100% {border-color: var(--default-color);}
			}
			.highlight {
				animation : highlight 3s;
			}
			.error {
				--default-color: red;
				--highlight-color: orange;
				border: 1px solid red;
				background: rgb(255, 221, 221);
				font-family: courier, monospace;
				overflow-x: auto;
				padding: 8px;
				margin-top: 8px;
			}
			.warning {
				border: 1px solid orange;
				background: #fff27d;
				font-family: courier, monospace;
				overflow-x: auto;
				padding: 8px;
				margin-top: 8px;
			}
		</style>
		<script type="module">
			const loading = document.getElementById('loading');
			addEventListener('py:all-done', () => loading.close());
			loading.showModal();
		</script>
		<script>
			function clear_notifications() {
				document.getElementById("errors").replaceChildren();
				document.getElementById("warnings").replaceChildren();
			}
			function add_error(content) {
				content = content.replace("&", "&amp")
				.replace(">", "&gt")
				.replace("<", "&lt")
				pre = document.createElement("pre")
				pre.innerHTML = content;
				pre.classList.add("error")
				document.getElementById("errors").append(pre)
				highlight_elem(pre)
			}
			function add_warning(content) {
				content = content.replace("&", "&amp")
				.replace(">", "&gt")
				.replace("<", "&lt")
				pre = document.createElement("pre")
				pre.innerHTML = content;
				pre.classList.add("warning")
				document.getElementById("warnings").append(pre)
			}
			function highlight_elem(elem) {
				elem.classList.remove('highlight');
				void elem.offsetWidth;
				elem.classList.add('highlight');
				elem.scrollIntoView({ behavior: "smooth"});
			}
			function check_json() {
				document.getElementById("warnings").replaceChildren();
				text = document.getElementById("work-area").value;
				if (!text)
					return ;
				try {
					encode_json(text, console.error);
					clear_notifications();
				} catch (error) {
					add_warning("Warning : Invalid json, check the console for more details");
					return ;
				}
			}
			addEventListener('py:all-done', check_json);
			function on_upload() {
				clear_notifications();
				document.getElementById("work-area").value = "loading...";
				var reader = new FileReader();
				reader.readAsText(this.files[0], "UTF-8");
				reader.onload = (evt) => {
					textarea = document.getElementById("work-area")
					text = evt.target.result
					const filename = this.files[0].name;
					if (filename.endsWith(".d13")) {
						decoded = decode_gamesave(text, add_error)
						textarea.value = decoded
					} else if (!filename.endsWith(".json")) {
						add_error("Cannot load file " + filename + "\nUnrecognized file extension");
					}
					highlight_elem(textarea)
				};
				reader.onerror = (evt) => {
					textarea = document.getElementById("work-area")
					highlight_elem(textarea)
					document.getElementById("work-area").value = "Error check console for further info";
				};
			}
			window.onload = () => {
				document.getElementById("upload").addEventListener("change", on_upload);
				document.getElementById("work-area").addEventListener("input", check_json);
			}
			function on_download(extension) {
				clear_notifications();
				const anchor = document.getElementById("hack-anchor");
				text = document.getElementById("work-area").value
				anchor.download = "gamesave." + extension;
				if (extension == "d13") {
					text = encode_json(text, add_error)
				}
				var blob = new Blob([text]);
				anchor.href = URL.createObjectURL(blob);
				anchor.click();
			}
		</script>
	</head>
	<body>
		<noscript>You need to enable JavaScript to run this app.</noscript>
		<dialog id="loading">
			<h1>Loading...</h1>
		</dialog>
		<h1>STAR: savefile tool for Star of Providence</h1>
		<div style="height:85%; width:90%; margin: auto;">
			<section class="pyscript full_height" style="display:flex; flex-flow:column; width:100%;">
				<textarea id="work-area" ></textarea>
				<div>
					<input class="hidden" type="file" id="upload" accept=".json, .d13"></input>
					<button onclick="document.getElementById('upload').click()">Upload</button>
					<button onclick="
						{navigator.clipboard.writeText(document.querySelector('#work-area').value).then(
							function () {alert('Copied to clipboard !')}
						)}">
						Copy to clipboard
					</button>
					<button id="download_d13" onclick="on_download('d13')">Download as .d13</button>
					<button id="download_json" onclick="on_download('json')">Download as json</button>
					<a download="gamesave" class="hidden" id="hack-anchor"></a>
				</div>
				<script type="py" src="./main.py" config="./pyscript.toml"></script>
				<div>
				</div>
			</section>
		</div>
		<div id="warnings"></div>
		<div id="errors"></div>
	</body>
</html>

